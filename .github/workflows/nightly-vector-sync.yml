name: Nightly Vector Database Sync

# Runs daily at 6 AM UTC (2 AM EST) to keep vector database fresh
# This is a workaround while investigating Celery Beat scheduler issue
on:
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC daily (2 AM EST)
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  sync-vectors:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for any ongoing deployments
        run: |
          echo "Waiting 30 seconds to ensure deployment is complete..."
          sleep 30

      - name: Trigger Notion Sync (1 day)
        run: |
          echo "ğŸ”„ Triggering Notion ingestion..."
          curl -X POST \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/notion?days=1" \
            || echo "âŒ Notion sync failed"
          sleep 5

      - name: Trigger Slack Sync (1 day)
        run: |
          echo "ğŸ”„ Triggering Slack ingestion..."
          curl -X POST \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/slack?days=1" \
            || echo "âŒ Slack sync failed"
          sleep 5

      - name: Trigger Jira Sync (1 day)
        run: |
          echo "ğŸ”„ Triggering Jira ingestion..."
          curl -X POST \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/jira?days=1" \
            || echo "âŒ Jira sync failed"
          sleep 5

      - name: Trigger Fireflies Sync (1 day)
        run: |
          echo "ğŸ”„ Triggering Fireflies ingestion..."
          curl -X POST \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/fireflies?days=1&limit=100" \
            || echo "âŒ Fireflies sync failed"
          sleep 5

      - name: Trigger Tempo Sync (1 day)
        run: |
          echo "ğŸ”„ Triggering Tempo ingestion..."
          curl -X POST \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/tempo?days=1" \
            || echo "âŒ Tempo sync failed"

      - name: Verify Sync Status
        run: |
          echo "ğŸ“Š Checking sync status..."
          sleep 60  # Wait for tasks to complete
          curl -s -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/sync-status" \
            || echo "âŒ Sync status check failed"
