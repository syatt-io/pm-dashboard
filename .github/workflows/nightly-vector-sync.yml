name: Nightly Vector Database Sync

# Runs daily at 6 AM UTC (2 AM EST) to keep vector database fresh with recent data
# Vector syncs: Notion, Slack, Jira, Fireflies, Tempo (1-day incremental)
# Note: Tempo hours sync (cumulative/monthly) now runs via Celery Beat at 4 AM EST
on:
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC daily (2 AM EST)
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  sync-vectors:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for any ongoing deployments
        run: |
          echo "Waiting 30 seconds to ensure deployment is complete..."
          sleep 30

      - name: Trigger Notion Sync (1 day)
        run: |
          echo "üîÑ Triggering Notion ingestion..."
          curl -X POST \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/notion?days=1" \
            || echo "‚ùå Notion sync failed"
          sleep 5

      - name: Trigger Slack Sync (1 day)
        run: |
          echo "üîÑ Triggering Slack ingestion..."
          curl -X POST \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/slack?days=1" \
            || echo "‚ùå Slack sync failed"
          sleep 5

      - name: Trigger Jira Sync (1 day)
        run: |
          echo "üîÑ Triggering Jira ingestion..."
          curl -X POST \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/jira?days=1" \
            || echo "‚ùå Jira sync failed"
          sleep 5

      - name: Trigger Fireflies Sync (1 day)
        run: |
          echo "üîÑ Triggering Fireflies ingestion..."
          curl -X POST \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/fireflies?days=1&limit=100" \
            || echo "‚ùå Fireflies sync failed"
          sleep 5

      - name: Trigger Tempo Vector Sync (1 day)
        run: |
          echo "üîÑ Triggering Tempo vector database ingestion..."
          curl -X POST \
            -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/tempo?days=1" \
            || echo "‚ùå Tempo vector sync failed"
          sleep 5

      # Tempo hours sync (cumulative/monthly) now handled by Celery Beat at 4 AM EST
      # See: src/tasks/celery_app.py:176-179 ('tempo-sync-daily' schedule)

      - name: Verify Sync Status
        run: |
          echo "üìä Checking sync status..."
          sleep 60  # Wait for tasks to complete
          curl -s -H "X-Admin-Key: ${{ secrets.ADMIN_API_KEY }}" \
            "https://agent-pm-tsbbb.ondigitalocean.app/api/backfill/sync-status" \
            || echo "‚ùå Sync status check failed"
